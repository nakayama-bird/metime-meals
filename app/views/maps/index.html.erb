<div class='text-center mt-6'>
  <%= render 'search_post_form', search_form: @search_form %>
  <p id="latitude" data-value="<%= @map_center_lat %>"></p>
  <p id="longitude" data-value="<%= @map_center_lng %>"></p>
</div>
<div>
    <div>
    <button id="current-location-button" class="btn btn-primary text-left">
        <span class="material-icons">location_on</span>
        <span class="block text-sm">現在地を取得する</span>
    </button>
    </div>
<div id="map" class="h-[37.5rem] w-full"></div>
</div>
<%# モーダルを表示する要素 %>
<dialog id="post_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <div class="post_show mt-4"></div>
    </div>
</dialog>
<script>
    let map, infoWindow;
    function initMap() {
    // 地図要所の取得
    const mapElement = document.getElementById('map');

    const latitudeElement = document.getElementById('latitude');
    const longitudeElement = document.getElementById('longitude');

    current_lat = parseFloat(latitudeElement.getAttribute('data-value'));
    current_lng = parseFloat(longitudeElement.getAttribute('data-value'));

    const lat =  current_lat? current_lat : 35.6803997;
    const lng =  current_lng? current_lng : 139.7690174;

    const defaultlocation = { lat: lat, lng: lng };

    // 初期表示の設定
    const mapOptions = {
        center: defaultlocation,
        zoom: 14,
    }

    const map = new google.maps.Map(mapElement, mapOptions);
    infoWindow = new google.maps.InfoWindow();
    
    map.addListener('center_changed', function() {
        const center = map.getCenter();
        const lat = center.lat();
        const lng = center.lng();

        // `hidden_field`に値を設定
        document.getElementById('map_center_lat').value = lat;
        document.getElementById('map_center_lng').value = lng;
    });
    

    // 位置情報取得用のボタンの定義
    const locationButton = document.getElementById("current-location-button");
    locationButton.classList.add("custom-map-control-button");
    map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);

    locationButton.addEventListener("click", () => {
      // 現在地を取得
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent("現在地が取得できました");
            infoWindow.open(map);
            map.setCenter(pos);
          },
          () => {
            handleLocationError(true, infoWindow, map.getCenter());
          }
        );
      } else {
        // ブラウザがGeolocationをサポートしていない場合
        alert('このブラウザは位置情報に対応していません');
        handleLocationError(false, infoWindow, map.getCenter());
      }
    });


    //投稿が存在するかで条件分岐
    <% if @posts.present? %>
    // 投稿一覧を地図上で表示
    <% @posts.each do |post| %>
      (() => {
        let marker = new google.maps.Marker({
            position: { lat: <%= post.latitude %>, lng: <%= post.longitude %> },
            map: map
        });

        marker.addListener('click', function() {
        const modalContent = `
        <div class='text-center mb-3'>
            <div><%= post.human_attribute_enum(:genre) %></div>
            <div class='text-lg font-semibold'><%= post.restaurant_name %></div>
            <p><%= post.address %></p>
            <div class="flex justify-center mt-3">
                <% post.tags.each do |tag| %>
                  <div class="badge badge-ghost badge-base mr-1 mt-1"><%= tag.name %></div>
                <% end %>
            </div>
        </div>
            <p>おすすめポイント<br><%= post.body %></p>
        <div class='text-center mt-3'>
            <%= link_to "詳細ページ", post_path(post), class: "btn btn-primary" %>
        </div>
        `;
        // post_showに取得したModalContentを代入してくれる
        document.querySelector('.post_show').innerHTML = modalContent;
        document.getElementById('post_modal').showModal();
        });
    })();
    <% end %>
    <% else %>
        console.log('投稿が存在しません');
    <% end %>
    }
    
  // 取得できなかった時の処理
  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    alert('位置情報の取得に失敗しました。');
    infoWindow.setPosition(pos);
    infoWindow.setContent(
      browserHasGeolocation
        ? "現在地の取得に失敗しました"
        : "このブラウザは位置情報に対応していません"
    );
    infoWindow.open(map);
  }

  window.initMap = initMap;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_API_KEY'] %>&callback=initMap"></script>